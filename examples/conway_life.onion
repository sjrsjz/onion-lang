// åº·å¨ç”Ÿå‘½æ¸¸æˆ (Conway's Game of Life)
@required stdlib;
@import "std/tui_colors.onion";

width := 60;
height := 40;
generations := 1000;

// ç®€å•çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ (çº¿æ€§åŒä½™ç”Ÿæˆå™¨)
rand_seed := mut 12345;
random := () -> {
    rand_seed = (rand_seed * 1103515245 + 12345) % 2147483648;
    return rand_seed / 2147483648.0;
};

// åˆ›å»ºåˆå§‹ç½‘æ ¼
create_grid := (w?, h?) -> {
    grid := mut ();
    y := mut 0;
    while (y < h) {
        row := mut ();
        x := mut 0;
        while (x < w) {
            // éšæœºåˆå§‹åŒ–ç»†èƒï¼ˆçº¦30%çš„å­˜æ´»ç‡ï¼‰
            alive := mut (random() < 0.3);  // ä½¿å¸ƒå°”å€¼å¯å˜
            row = row + (alive,);
            x = x + 1;
        };
        grid = grid + (row,);
        y = y + 1;
    };
    return grid;
};

// è®¡ç®—é‚»å±…æ•°é‡
count_neighbors := (grid?, x?, y?, w?, h?) -> {
    count := mut 0;
    dy := mut (-1);
    while (dy <= 1) {
        dx := mut (-1);
        while (dx <= 1) {
            if (not (dx == 0 and dy == 0)) {
                nx := x + dx/0;
                ny := y + dy;
                if (nx >= 0 and nx < w and ny >= 0 and ny < h) {
                    if (grid[ny][nx]) {
                        count = count + 1;
                    };
                };
            };
            dx = dx + 1;
        };
        dy = dy + 1;
    };
    return count;
};

// æ›´æ–°ç½‘æ ¼åˆ°ç¼“å†²åŒº
update_grid := (current_grid?, buffer_grid?, w?, h?) -> {
    y := mut 0;
    while (y < h) {
        x := mut 0;
        while (x < w) {
            neighbors := count_neighbors(current_grid, x, y, w, h);
            current := current_grid[y][x];
            
            // åº·å¨ç”Ÿå‘½æ¸¸æˆè§„åˆ™
            new_cell := if (current) {
                // æ´»ç»†èƒï¼š2-3ä¸ªé‚»å±…å­˜æ´»ï¼Œå¦åˆ™æ­»äº¡
                neighbors == 2 or neighbors == 3
            } else {
                // æ­»ç»†èƒï¼šæ­£å¥½3ä¸ªé‚»å±…å¤æ´»
                neighbors == 3
            };
            
            buffer_grid[y][x] = new_cell;
            x = x + 1;
        };
        y = y + 1;
    };
};

// äº¤æ¢ç¼“å†²åŒºå†…å®¹
swap_buffers := (grid1?, grid2?, w?, h?) -> {
    y := mut 0;
    while (y < h) {
        x := mut 0;
        while (x < w) {
            temp := grid1[y][x];  // ä½¿ä¸´æ—¶å˜é‡å¯å˜
            grid1[y][x] = grid2[y][x];
            grid2[y][x] = temp;
            x = x + 1;
        };
        y = y + 1;
    };
};

// åŒç¼“å†²æ¸²æŸ“ - é¢„å…ˆæ„å»ºå®Œæ•´æ˜¾ç¤ºæ–‡æœ¬
render_frame := (grid?, w?, h?, generation?) -> {
    // åˆ›å»ºæ–‡æœ¬ç¼“å†²åŒº
    display_buffer := mut "";
    
    // æ¸…å±å’Œå…‰æ ‡å¤ä½
    display_buffer = display_buffer + "\u001b[2J\u001b[H";
    
    // æ„å»ºæ ‡é¢˜
    title := "ğŸ”¬ åº·å¨ç”Ÿå‘½æ¸¸æˆ [ç¬¬" + stdlib.types.to_string(generation) + "ä»£] ğŸ§¬";
    display_buffer = display_buffer + colorize(title, "bright_cyan", "bg_black") + "\n";
    
    // ç»Ÿè®¡æ´»ç»†èƒæ•°é‡
    alive_count := mut 0;
    y := mut 0;
    while (y < h) {
        x := mut 0;
        while (x < w) {
            if (grid[y][x]) {
                alive_count = alive_count + 1;
            };
            x = x + 1;
        };
        y = y + 1;
    };
    
    // æ„å»ºä¿¡æ¯è¡Œ
    info := "æ´»ç»†èƒ: " + stdlib.types.to_string(alive_count) + " | åŒç¼“å†²æ¸²æŸ“ | å°ºå¯¸: " + stdlib.types.to_string(w) + "x" + stdlib.types.to_string(h);
    display_buffer = display_buffer + colorize(info, "bright_yellow", "bg_black") + "\n";
    
    // æ„å»ºè¾¹æ¡†é¡¶éƒ¨
    border_top := mut "â”Œ";
    x := mut 0;
    while (x < w * 2) {
        border_top = border_top + "â”€";
        x = x + 1;
    };
    border_top = border_top + "â”";
    display_buffer = display_buffer + colorize(border_top, "bright_white", "bg_black") + "\n";
    
    // æ„å»ºç½‘æ ¼å†…å®¹
    y = 0;
    while (y < h) {
        row_text := mut "â”‚";
        x = 0;
        while (x < w) {
            if (grid[y][x]) {
                row_text = row_text + colorize("â–ˆâ–ˆ", "bright_green", "bg_black");
            } else {
                row_text = row_text + "  ";
            };
            x = x + 1;
        };
        row_text = row_text + colorize("â”‚", "bright_white", "bg_black");
        display_buffer = display_buffer + row_text + "\n";
        y = y + 1;
    };
    
    // æ„å»ºè¾¹æ¡†åº•éƒ¨
    border_bottom := mut "â””";
    x = 0;
    while (x < w * 2) {
        border_bottom = border_bottom + "â”€";
        x = x + 1;
    };
    border_bottom = border_bottom + "â”˜";
    display_buffer = display_buffer + colorize(border_bottom, "bright_white", "bg_black") + "\n";
    
    // æ„å»ºè¯´æ˜ä¿¡æ¯
    rules := "è§„åˆ™: æ´»ç»†èƒ2-3é‚»å±…å­˜æ´» | æ­»ç»†èƒ3é‚»å±…å¤æ´» | å…¶ä»–æƒ…å†µæ­»äº¡";
    display_buffer = display_buffer + colorize(rules, "bright_cyan", "bg_black") + "\n";
    
    // ä¸€æ¬¡æ€§è¾“å‡ºå®Œæ•´çš„æ˜¾ç¤ºç¼“å†²åŒº
    stdlib.io.print(display_buffer);
};

// ä¸»å¾ªç¯ - ä½¿ç”¨åŒç¼“å†²æŠ€æœ¯å’Œé¢„æ¸²æŸ“
current_grid := mut create_grid(width, height);
buffer_grid := mut create_grid(width, height);  // åˆ›å»ºç¼“å†²åŒº
generation := mut 0;

// æ¸…ç©ºç¼“å†²åŒºï¼ˆåˆå§‹åŒ–ä¸ºfalseï¼‰
y := mut 0;
while (y < height) {
    x := mut 0;
    while (x < width) {
        buffer_grid[y][x] = mut false;  // ä½¿å¸ƒå°”å€¼å¯å˜
        x = x + 1;
    };
    y = y + 1;
};

startup_msg := colorize("ğŸ® åº·å¨ç”Ÿå‘½æ¸¸æˆå¯åŠ¨ï¼ä½¿ç”¨åŒç¼“å†²+é¢„æ¸²æŸ“æŠ€æœ¯", "bright_magenta", "bg_black");
stdlib.io.println(startup_msg);
stdlib.io.println(colorize("æŒ‰Ctrl+Cé€€å‡ºç¨‹åº", "bright_yellow", "bg_black"));

while (generation < generations) {
    // é¢„å…ˆæ„å»ºå®Œæ•´å¸§å¹¶ä¸€æ¬¡æ€§è¾“å‡º
    render_frame(current_grid, width, height, generation);
    
    // æš‚åœä¸€ä¸‹ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°åŠ¨ç”»
    stdlib.time.sleep_millis(20);
    
    // è®¡ç®—ä¸‹ä¸€ä»£åˆ°ç¼“å†²åŒº
    update_grid(current_grid, buffer_grid, width, height);
    
    // äº¤æ¢ç¼“å†²åŒºï¼ˆåŒç¼“å†²æ ¸å¿ƒï¼‰
    swap_buffers(current_grid, buffer_grid, width, height);
    
    generation = generation + 1;
};

stdlib.io.println(colorize("ğŸ­ ç”Ÿå‘½æ¸¸æˆç»“æŸï¼åŒç¼“å†²+é¢„æ¸²æŸ“æ¼”ç¤ºå®Œæˆï¼", "bright_yellow", "bg_black"));
stdlib.io.println(colorize("æ„Ÿè°¢ä½“éªŒæµç•…çš„æ¸²æŸ“æŠ€æœ¯ï¼", "bright_green", "bg_black"));
