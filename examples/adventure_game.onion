// æ–‡æœ¬å†’é™©æ¸¸æˆï¼šé­”æ³•æ£®æ—æ¢é™©
@required stdlib;
@import "std/tui_colors.onion";

// ç®€å•çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨
rand_seed := mut 12345;
random := () -> {
    rand_seed = (rand_seed * 1103515245 + 12345) % 2147483648;
    return rand_seed / 2147483648.0;
};

// æ¸¸æˆçŠ¶æ€
player := {
    "name": "å†’é™©è€…",
    "health": mut 100,
    "magic": mut 50,
    "items": mut ("ç«æŠŠ", "é¢åŒ…"),
    "location": mut "forest_entrance"
};

// æ¸¸æˆä¸–ç•Œåœ°å›¾
world := {
    'forest_entrance': {
        "name": "æ£®æ—å…¥å£",
        "description": "ä½ ç«™åœ¨ä¸€ç‰‡ç¥ç§˜æ£®æ—çš„å…¥å£ã€‚å¤è€çš„æ ‘æœ¨é«˜è€¸å…¥äº‘ï¼Œå¾®é£ä¸­ä¼ æ¥ç¥ç§˜çš„ä½è¯­å£°ã€‚",
        "exits": ('north': "deep_forest", 'east': "crystal_cave"),
        "items": ("é­”æ³•è¯æ°´",),
        "events": ("encounter_fairy",)
    },
    'deep_forest': {
        "name": "æ£®æ—æ·±å¤„",
        "description": "æµ“å¯†çš„æ ‘å¶é®å¤©è”½æ—¥ï¼Œåªæœ‰é›¶æ˜Ÿçš„é˜³å…‰æ´’åœ¨æ£®æ—åœ°é¢ä¸Šã€‚ä½ å¬åˆ°è¿œå¤„ä¼ æ¥ç¥ç§˜çš„å’†å“®å£°ã€‚",
        "exits": ('south': "forest_entrance", 'west': "ancient_tree", 'north': "dragon_lair"),
        "items": ("ç²¾çµä¹‹å¼“",),
        "events": ("encounter_wolf",)
    },
    'crystal_cave': {
        "name": "æ°´æ™¶æ´ç©´",
        "description": "æ´ç©´ä¸­é—ªçƒç€äº”å…‰åè‰²çš„æ°´æ™¶ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€é­”æ³•çš„æ°”æ¯ã€‚",
        "exits": ('west': "forest_entrance", 'north': "treasure_room"),
        "items": ("æ°´æ™¶ç¢ç‰‡",),
        "events": ("find_treasure",)
    },
    'ancient_tree': {
        "name": "è¿œå¤å·¨æ ‘",
        "description": "ä¸€æ£µå·¨å¤§çš„å¤æ ‘çŸ—ç«‹åœ¨ä½ é¢å‰ï¼Œæ ‘å¹²ä¸Šåˆ»æ»¡äº†å¤è€çš„ç¬¦æ–‡ã€‚",
        "exits": ('east': "deep_forest",),
        "items": ("æ™ºæ…§ä¹‹æœ",),
        "events": ("tree_spirit",)
    },
    'dragon_lair': {
        "name": "å·¨é¾™å·¢ç©´",
        "description": "ä¸€ä¸ªé»‘æš—çš„æ´ç©´ï¼Œåœ°é¢ä¸Šæ•£è½ç€é‡‘å¸å’Œå®çŸ³ã€‚ä½ èƒ½æ„Ÿå—åˆ°å¼ºå¤§é­”æ³•ç”Ÿç‰©çš„å­˜åœ¨ã€‚",
        "exits": ('south': "deep_forest",),
        "items": ("é¾™é³", "é»„é‡‘",),
        "events": ("final_boss",)
    },
    'treasure_room': {
        "name": "å®è—å®¤",
        "description": "ä¸€ä¸ªéšç§˜çš„å®è—å®¤ï¼Œè£…æ»¡äº†é—ªé—ªå‘å…‰çš„å®ç‰©ã€‚",
        "exits": ('south': "crystal_cave",),
        "items": ("ä¼ è¯´å®å‰‘", "é­”æ³•æŠ¤ç¬¦"),
        "events": ("victory",)
    }
};

// éšæœºäº‹ä»¶ç³»ç»Ÿ
events := {
    'encounter_fairy': {
        "description": "ä¸€ä¸ªç¾ä¸½çš„ç²¾çµå‡ºç°åœ¨ä½ é¢å‰ï¼Œå¥¹çš„ç¿…è†€æ•£å‘ç€æŸ”å’Œçš„å…‰èŠ’ã€‚",
        "options": (
            ('å’Œç²¾çµäº¤è°ˆ': "fairy_talk"),
            ('ç»™ç²¾çµç¤¼ç‰©': "fairy_gift"),
            ('ç»§ç»­å‰è¡Œ': "continue")
        )
    },
    'encounter_wolf': {
        "description": "ä¸€åªå·¨å¤§çš„æ£®æ—ç‹¼æŒ¡ä½äº†ä½ çš„å»è·¯ï¼Œå®ƒçš„çœ¼ç›é—ªçƒç€é‡æ€§çš„å…‰èŠ’ã€‚",
        "options": (
            ('æˆ˜æ–—': "wolf_fight"),
            ('å°è¯•é©¯æœ': "wolf_tame"),
            ('é€ƒè·‘': "wolf_flee")
        )
    },
    'find_treasure': {
        "description": "ä½ åœ¨æ°´æ™¶ä¸­å‘ç°äº†ä¸€ä¸ªéšè—çš„å®ç®±ï¼",
        "options": (
            ('æ‰“å¼€å®ç®±': "open_chest"),
            ('æ£€æŸ¥é™·é˜±': "check_trap"),
            ('å¿½ç•¥å®ç®±': "ignore_chest")
        )
    },
    'tree_spirit': {
        "description": "è¿œå¤å·¨æ ‘çš„ç²¾çµè‹é†’äº†ï¼Œå®ƒå¤è€çš„å£°éŸ³åœ¨ä½ å¿ƒä¸­å“èµ·ã€‚",
        "options": (
            ('è¯·æ±‚æ™ºæ…§': "ask_wisdom"),
            ('è¯·æ±‚åŠ›é‡': "ask_power"),
            ('è¡¨ç¤ºæ•¬æ„': "show_respect")
        )
    },
    'final_boss': {
        "description": "ä¸€æ¡å·¨å¤§çš„çº¢é¾™ä»é˜´å½±ä¸­ç°èº«ï¼å®ƒçš„é³ç‰‡å¦‚ç«ç„°èˆ¬é—ªçƒã€‚",
        "options": (
            ('è‹±å‹‡æˆ˜æ–—': "dragon_fight"),
            ('å°è¯•è°ˆåˆ¤': "dragon_talk"),
            ('ä½¿ç”¨é­”æ³•': "dragon_magic")
        )
    },
    'victory': {
        "description": "æ­å–œï¼ä½ æ‰¾åˆ°äº†ä¼ è¯´ä¸­çš„å®è—ï¼Œæˆä¸ºäº†çœŸæ­£çš„è‹±é›„ï¼",
        "options": (
            ('åº†ç¥èƒœåˆ©': "celebrate"),
        )
    }
};

// æ˜¾ç¤ºå½“å‰çŠ¶æ€
display_status := () -> {
    stdlib.io.println(colorize("â•â•â• ç©å®¶çŠ¶æ€ â•â•â•", "bright_yellow", "bg_black"));
    stdlib.io.println(colorize("å§“å: " + player.name, "bright_green", "bg_black"));
    stdlib.io.println(colorize("ç”Ÿå‘½å€¼: " + stdlib.types.to_string(player.health) + "/100", "bright_red", "bg_black"));
    stdlib.io.println(colorize("é­”æ³•å€¼: " + stdlib.types.to_string(player.magic) + "/100", "bright_blue", "bg_black"));
      items_str := mut "ç‰©å“: ";
    i := mut 0;
    while (i < lengthof player.items) {
        items_str = items_str + player.items[i];
        if (i < lengthof player.items - 1) {
            items_str = items_str + ", ";
        };
        i = i + 1;
    };
    stdlib.io.println(colorize(items_str, "bright_cyan", "bg_black"));
    stdlib.io.println("");
};

// æ˜¾ç¤ºå½“å‰ä½ç½®
display_location := () -> {
    current_location := world.{player.location};
    
    stdlib.io.println(colorize("ğŸŒŸ " + current_location.name + " ğŸŒŸ", "bright_magenta", "bg_black"));
    stdlib.io.println(colorize(current_location.description, "white", "bg_black"));
    stdlib.io.println("");
    
    // æ˜¾ç¤ºå¯ç”¨å‡ºå£
    if (keyof (sync (() -> current_location.exits))()) {
        stdlib.io.println(colorize("å¯å‰å¾€çš„æ–¹å‘:", "bright_yellow", "bg_black"));
        exits := current_location.exits;
        i := mut 0;
        while (i < lengthof exits) {
            direction := keyof exits[i];
            destination := valueof exits[i];
            dest_name := world.{destination}.name;
            stdlib.io.println(colorize("  " + direction + " â†’ " + dest_name, "bright_green", "bg_black"));
            i = i + 1;
        };
        stdlib.io.println("");
    };
    
    // æ˜¾ç¤ºå¯è·å¾—çš„ç‰©å“
    if (keyof (sync (() -> current_location.items))() and lengthof current_location.items > 0) {
        stdlib.io.println(colorize("è¿™é‡Œæœ‰ç‰©å“:", "bright_cyan", "bg_black"));
        i := mut 0;
        while (i < lengthof current_location.items) {
            stdlib.io.println(colorize("  âœ¨ " + current_location.items[i], "bright_white", "bg_black"));
            i = i + 1;
        };
        stdlib.io.println("");
    };
};

// å¤„ç†äº‹ä»¶
handle_event := (event_name?) -> {
    if (not keyof (sync (() -> events.{event_name}))()) {
        return;
    };
    
    event := events.{event_name};
    stdlib.io.println(colorize("ğŸ­ äº‹ä»¶å‘ç”Ÿ ğŸ­", "bright_magenta", "bg_black"));
    stdlib.io.println(colorize(event.description, "yellow", "bg_black"));
    stdlib.io.println("");
    
    stdlib.io.println(colorize("ä½ çš„é€‰æ‹©:", "bright_yellow", "bg_black"));
    i := mut 0;
    while (i < lengthof event.options) {
        option := event.options[i];
        choice_text := keyof option;
        stdlib.io.println(colorize(stdlib.types.to_string(i + 1) + ". " + choice_text, "bright_green", "bg_black"));
        i = i + 1;
    };
      // æ¨¡æ‹Ÿç©å®¶é€‰æ‹© (è¿™é‡Œéšæœºé€‰æ‹©)
    choice := stdlib.math.floor(random() * lengthof event.options);
    selected_option := event.options[choice];
    action := valueof selected_option;
    
    stdlib.io.println("");
    stdlib.io.println(colorize("ä½ é€‰æ‹©äº†: " + keyof selected_option, "bright_cyan", "bg_black"));
    
    // å¤„ç†é€‰æ‹©ç»“æœ
    if (action == "fairy_talk") {
        stdlib.io.println(colorize("ç²¾çµå‘Šè¯‰äº†ä½ æ£®æ—çš„ç§˜å¯†ï¼Œä½ çš„é­”æ³•å€¼å¢åŠ äº†ï¼", "bright_blue", "bg_black"));
        player.magic = player.magic + 20;
        if (player.magic > 100) { player.magic = 100; };
    } else if (action == "wolf_fight") {
        stdlib.io.println(colorize("ä½ ä¸ç‹¼è¿›è¡Œäº†æ¿€çƒˆçš„æˆ˜æ–—ï¼Œè™½ç„¶è·èƒœä½†å—äº†ä¼¤ã€‚", "bright_red", "bg_black"));
        player.health = player.health - 20;
        player.items = player.items + ("ç‹¼çš®",);
    } else if (action == "open_chest") {
        stdlib.io.println(colorize("å®ç®±ä¸­æœ‰çè´µçš„å®çŸ³ï¼", "bright_yellow", "bg_black"));
        player.items = player.items + ("çº¢å®çŸ³",);
    } else if (action == "ask_wisdom") {
        stdlib.io.println(colorize("æ ‘ç²¾èµäºˆäº†ä½ æ™ºæ…§ï¼Œä½ å­¦ä¼šäº†æ²»æ„ˆé­”æ³•ï¼", "bright_green", "bg_black"));
        player.health = 100;
        player.magic = 100;
    } else if (action == "dragon_fight") {
        if (player.health > 50) {
            stdlib.io.println(colorize("ä½ è‹±å‹‡åœ°å‡»è´¥äº†å·¨é¾™ï¼è·å¾—äº†é¾™çš„å®è—ï¼", "bright_yellow", "bg_black"));
            player.items = player.items + ("é¾™å¿ƒ", "ä¼ å¥‡æ­¦å™¨");
        } else {
            stdlib.io.println(colorize("ä½ çš„åŠ›é‡ä¸è¶³ä»¥å¯¹æŠ—å·¨é¾™ï¼Œä½†ä½ çš„å‹‡æ°”æ„ŸåŠ¨äº†å®ƒã€‚", "bright_blue", "bg_black"));
            player.items = player.items + ("é¾™çš„ç¥ç¦",);
        };
    } else if (action == "celebrate") {
        stdlib.io.println(colorize("ğŸ‰ ä½ å®Œæˆäº†è¿™æ¬¡ä¼Ÿå¤§çš„å†’é™©ï¼ ğŸ‰", "bright_magenta", "bg_black"));
        return true;
    } else {
        stdlib.io.println(colorize("ä½ ç»§ç»­äº†ä½ çš„å†’é™©...", "white", "bg_black"));
    };
    
    stdlib.io.println("");
    return false;
};

// æ¨¡æ‹Ÿæ¢ç´¢
simulate_exploration := () -> {
    locations_to_visit := ("forest_entrance", "deep_forest", "crystal_cave", "ancient_tree", "dragon_lair", "treasure_room");
    
    i := mut 0;
    while (i < lengthof locations_to_visit) {
        player.location = locations_to_visit[i];
        
        // æ¸…å±
        stdlib.io.println("\u001b[2J\u001b[H");
        
        // æ˜¾ç¤ºæ¸¸æˆæ ‡é¢˜
        stdlib.io.println(colorize("ğŸ—¡ï¸  é­”æ³•æ£®æ—æ¢é™©  ğŸ—¡ï¸", "bright_yellow", "bg_black"));
        stdlib.io.println("");
        
        display_status();
        display_location();
        
        // è§¦å‘äº‹ä»¶
        current_location := world.{player.location};
        if (keyof (sync (() -> current_location.events))() and lengthof current_location.events > 0) {
            event_name := current_location.events[0];
            game_ended := handle_event(event_name);
            if (game_ended) {
                break;
            };
        };
        
        // è‡ªåŠ¨æ‹¾å–ç‰©å“
        if (keyof (sync (() -> current_location.items))() and lengthof current_location.items > 0) {
            j := mut 0;
            while (j < lengthof current_location.items) {
                item := current_location.items[j];
                player.items = player.items + (item,);
                stdlib.io.println(colorize("ä½ è·å¾—äº†: " + item, "bright_green", "bg_black"));
                j = j + 1;
            };
            stdlib.io.println("");
        };
        
        // å»¶è¿Ÿ
        delay := mut 0;
        while (delay < 300000) {
            delay = delay + 1;
        };
        
        i = i + 1;
    };
};

// å¼€å§‹æ¸¸æˆ
stdlib.io.println(colorize("æ¬¢è¿æ¥åˆ°é­”æ³•æ£®æ—æ¢é™©ï¼", "bright_magenta", "bg_black"));
stdlib.io.println(colorize("æŒ‰ä¸‹å›è½¦å¼€å§‹ä½ çš„å†’é™©...", "bright_cyan", "bg_black"));

simulate_exploration();

stdlib.io.println(colorize("æ„Ÿè°¢æ¸¸ç©é­”æ³•æ£®æ—æ¢é™©ï¼", "bright_yellow", "bg_black"));
