// é«˜çº§ FFI æ¼”ç¤ºï¼šè°ƒç”¨ Windows API
@required stdlib;

main := () -> {
    stdlib.io.println("==================================================");
    stdlib.io.println("=== Onion FFI Advanced Demo: Windows API Calls ===");
    stdlib.io.println("==================================================");
    stdlib.io.println("");

    // æ­¤æ¼”ç¤ºä»…åœ¨ Windows ä¸Šè¿è¡Œ
    if (stdlib.sys.platform() != "windows") {
        stdlib.io.println("This demo is for Windows only. Skipping.");
        return;
    };

    stdlib.io.println("ğŸ“¦ Loading user32.dll...");
    user32_lib := stdlib.ffi.lib.load(path => "user32.dll");

    if (user32_lib == null) {
        stdlib.io.println("âœ— Failed to load user32.dll. Cannot proceed.");
        return;
    };
    stdlib.io.println("âœ“ user32.dll loaded successfully!");
    stdlib.io.println("");

    // --- æ¼”ç¤º 1: ç®€å•çš„ä¿¡æ¯æ¡† ---
    stdlib.io.println("ğŸ”§ Demo 1: Simple Information Message Box");
    
    // è·å– MessageBoxA å‡½æ•°å¥æŸ„
    // C ç­¾å: int MessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType);
    // æˆ‘ä»¬ä½¿ç”¨ 'A' ç‰ˆæœ¬ (MessageBoxA) æ˜¯å› ä¸ºå®ƒæ¥å—å¸¸è§„çš„ C å­—ç¬¦ä¸² (LPCSTR)ï¼Œ
    // è¿™ä¸æˆ‘ä»¬çš„ `string` ç±»å‹å®Œç¾åŒ¹é…ã€‚
    msgbox_handle := stdlib.ffi.lib.get_function(
        library => user32_lib,
        function => "MessageBoxA",
        return_type => "i32",
        param_types => ("pointer", "string", "string", "u32")
    );

    if (msgbox_handle == null) {
        stdlib.io.println("âœ— Failed to get MessageBoxA function handle.");
        return;
    };
    stdlib.io.println("âœ“ Got MessageBoxA handle.");

    // å‡†å¤‡å‚æ•°
    // hWnd (HWND): çª—å£å¥æŸ„ï¼Œä¼  0 (null) è¡¨ç¤ºæ— æ‰€æœ‰è€…çª—å£ã€‚
    // uType (UINT): æ¶ˆæ¯æ¡†çš„æ ·å¼ã€‚0x40 ä»£è¡¨ MB_ICONINFORMATIONã€‚
    hwnd := stdlib.ffi.ctypes.pointer(value => 0);
    text := stdlib.ffi.ctypes.string(value => "This is a message from an Onion script!");
    caption := stdlib.ffi.ctypes.string(value => "Onion FFI Demo");
    msg_type := stdlib.ffi.ctypes.u32(value => 64); // 0x40 for MB_ICONINFORMATION

    stdlib.io.println("  Calling MessageBoxA with an informational message...");
    stdlib.io.println("  (A dialog box should appear on your screen)");

    // è°ƒç”¨å‡½æ•°
    result := stdlib.ffi.lib.call(
        handle => msgbox_handle,
        args => (hwnd, text, caption, msg_type)
    );

    stdlib.io.println("  MessageBoxA returned:", valueof result, "(1 means OK was clicked)");
    stdlib.io.println("");


    // --- æ¼”ç¤º 2: å¸¦é€‰é¡¹çš„ç¡®è®¤æ¡† ---
    stdlib.io.println("ğŸ”§ Demo 2: Question Message Box with Yes/No/Cancel");

    // å‡†å¤‡å‚æ•°
    // uType: MB_YESNOCANCEL | MB_ICONQUESTION (0x03 | 0x20)
    q_text := stdlib.ffi.ctypes.string(value => "Do you enjoy using Onion Language's FFI?");
    q_caption := stdlib.ffi.ctypes.string(value => "Question");
    q_type := stdlib.ffi.ctypes.u32(value => 35); // 3 (MB_YESNOCANCEL) + 32 (MB_ICONQUESTION)

    stdlib.io.println("  Calling MessageBoxA with a question...");
    stdlib.io.println("  (Please click a button on the dialog box)");

    // è°ƒç”¨å‡½æ•°
    q_result_val := stdlib.ffi.lib.call(
        handle => msgbox_handle,
        args => (hwnd, q_text, q_caption, q_type)
    );
    q_result := valueof q_result_val;

    stdlib.io.println("  MessageBoxA returned:", q_result);

    // è§£æè¿”å›å€¼
    // IDYES = 6, IDNO = 7, IDCANCEL = 2
    if (q_result == 6) {
        stdlib.io.println("  You clicked 'Yes'. That's great to hear!");
    } else if (q_result == 7) {
        stdlib.io.println("  You clicked 'No'. We'll keep improving!");
    } else if (q_result == 2) {
        stdlib.io.println("  You clicked 'Cancel'.");
    } else {
        stdlib.io.println("  An unexpected button was clicked or the dialog was closed.");
    };
    stdlib.io.println("");

    stdlib.io.println("==================================================");
    stdlib.io.println("=== Windows API Demo Complete ===");
    stdlib.io.println("==================================================");
};

main();